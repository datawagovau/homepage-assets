<div class="divTableCell top" id="organisations">
  <h1>Latest datasets</h1>
</div>

<script>

function populateLatestDatasets() {

  var organisations = document.getElementById("organisations");
  //Controls the number of datasets shown per organisation before we display the 'And x more datasets' message.
  var max_datasets_per_org = 5;
  var ckan_base_url = "https://catalogue.data.wa.gov.au";
  
  var latestsDatasetsRequest = new XMLHttpRequest();
  latestsDatasetsRequest.open('GET', ckan_base_url+'/api/3/action/group_show?id=new-datasets&include_datasets=true');
  
  latestsDatasetsRequest.onerror = function() {
	organisations.insertAdjacentHTML('beforeend', "Sorry, we're having trouble reaching the data catalogue at the moment. Please check back later.");
  }

  latestsDatasetsRequest.onload = function () {
    var response = JSON.parse(latestsDatasetsRequest.responseText);
    var organisationTitles = [];

  if (response.result.package_count == 0) {
    organisations.insertAdjacentHTML('beforeend', "There aren't any new datasets at the moment.");
  } else {
    for (var i = 0; i < response.result.package_count; i++) {
      if (organisationTitles.indexOf(response.result.packages[i].organization.title) == -1) {
        organisationTitles.push(response.result.packages[i].organization.title);
      }
    }

    for (var i = 0; i < organisationTitles.length; i++) {
      var org_title = organisationTitles[i];
      organisations.insertAdjacentHTML('beforeend', "<h2>" + org_title + "</h2><ul id='" + org_title + "'></ul>");
      var organisationDatasetsList = document.getElementById(organisationTitles[i]);
      var counter = 0;
	  
      var org_packages = response.result.packages.filter(function(package) {
        return package.organization.title == org_title;
      });		  
      
      for (var k = 0; k < org_packages.length; k++) {
        counter++;
        organisationDatasetsList.insertAdjacentHTML('beforeend', "<li><a href='" + ckan_base_url + "/dataset/" + org_packages[k].name +"'>"+ org_packages[k].title +"</a></li>");
        //displays first 5 datasets, if there are more display "and more..." message
        if (counter == max_datasets_per_org && org_packages.length > max_datasets_per_org) {
          var dataset_remaining = org_packages.length - max_datasets_per_org;
          var dataset_term = (dataset_remaining == 1) ? "dataset" : "datasets";
          organisationDatasetsList.insertAdjacentHTML('beforeend', "<li> and " + (dataset_remaining) + " more " + dataset_term + ". </li>");
          break;
          }
        }
      }
    }
  }
  latestsDatasetsRequest.send();
};

populateLatestDatasets();
</script>
